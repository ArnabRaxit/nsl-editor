<% increment_tab_index(0) %>

<% if @current_workspace %>
    <h5>
      <% if @current_workspace.tree_type == 'P' %>
          Placement in <%= @current_workspace.derivedLabel %>
      <% elsif @current_workspace.tree_type == 'U' %>
          Placement in <%= @current_workspace.derivedLabel %><br/>
          Using workspace "<%= @current_workspace.title %>"
      <% else %>
          Classification (<%= @current_workspace.derivedLabel %> of type <%= @current_workspace.tree_type %>)
      <% end %>
    </h5>
    <div>
      <b>Name</b>: <%= raw(@instance.name.full_name_html) %>
    </div>
    <div>
      <b>Reference</b>: <%= raw(@instance.reference.citation_html) %>
    </div>

    <%
      # prefetch this - we will be using it a fair bit
      placement = @current_workspace.find_placement_of_name(@instance.name)
    %>

    <% if placement.nil?
         namePlaced = false
         instancePlaced = false
    %>
        <b><%= @current_workspace.derivedLabel %> status</b>: Non <%= @current_workspace.derivedLabel %>.
    <% elsif placement.subnode.instance == @instance
         namePlaced = true
         instancePlaced = true
    %>
        <div>
          <b><%= @current_workspace.derivedLabel %> Status</b>:

          <%=
            case placement.subnode.type_uri_id_part
              when 'ApcConcept' then
                'accepted'
              when 'ApcExcluded' then
                'excluded name'
              when 'DeclaredBt' then
                "non-#{@current_workspace.derivedLabel } parent"
              else
                placement.subnode.node_type_uri_id_part
            end
          %>
        </div>

        <div>
          <b><%= @current_workspace.derivedLabel %> Parent</b>:
          <% if placement.supernode.type_uri_id_part == 'classification-root' %>
              no name (top-level instance)
          <% else %>
              <%= raw(placement.supernode.name.full_name_html) %>
          <% end %>
        </div>
    <% else
         namePlaced = true
         instancePlaced = false
    %>

        <div>
          <b>Current <%= @current_workspace.derivedLabel %> Reference</b>:
          <% if placement.subnode.instance.reference.nil? %>
              (name placed without reference)
          <% else %>
              <%= raw(placement.subnode.instance.reference.citation_html) %>
          <% end %>
        </div>

        <div>
          <b> <%= @current_workspace.derivedLabel %> Parent</b>:
          <% if placement.supernode.type_uri_id_part == 'classification-root' %>
              no name (top-level instance)
          <% else %>
              <%= raw(placement.supernode.name.full_name_html) %>
          <% end %>
        </div>


    <% end %>

    <%= divider %>

    <%#TODO: move this block to _classification_edit_widgets or similar %>
    <% if @current_workspace.editableBy?(@current_user) %>
        <% if !@instance.cited_by_id %>
            <%= form_for(@current_workspace, controller: 'Trees', action: 'patch', remote: true, url: :tree_arrangement_place_name) do |f| %>
                <%= f.hidden_field(:name_id, value: @instance.name.id) %>
                <%= f.hidden_field(:instance_id, value: @instance.id) %>
                <h3>
                  <% if instancePlaced %>
                      Update name in <%= @current_workspace.derivedLabel %>
                  <% elsif namePlaced %>
                      Update name in <%= @current_workspace.derivedLabel %>
                  <% else %>
                      Place name in <%= @current_workspace.derivedLabel %>
                  <% end %>
                </h3>

                <%
                  if namePlaced
                    placementType =  placement.subnode.type_uri_id_part
                  else
                    placementType = 'ApcConcept' # default value
                  end
                %>
                <div class="form-group">
                  <label><%= @current_workspace.derivedLabel %> Status</label>

                  <div >
                  <input id="radioAccepted" type="radio" name="placement_type" value="accepted"
                         <%= (placementType=='ApcConcept' ? 'checked="yes"' : '')%>
                  />
                  <label for="radioAccepted">Accepted</label>
                  &nbsp;
                  <input id="radioExcluded" type="radio" name="placement_type" value="excluded"
                        <%= (placementType=='ApcExcluded' ? 'checked="yes"' : '')%>
                  />
                  <label for="radioExcluded">Excluded</label>
                  &nbsp;
                  <input id="radioUntreated"  type="radio" name="placement_type" value="untreated"
                         <%= (placementType=='DeclaredBt' ? 'checked="yes"' : '')%>
                  />
                  <label for="radioUntreated">Untreated</label>
                  </div>
                </div>

                <div class="form-group">
                  <label>APC Parent</label>

                  <input type="text"
                         class="form-control"
                         title="APC Parent"
                         name="parent_name"
                         value="<%=
                           namePlaced  ? placement.supernode.name.full_name : ''
                                  %>"
                  >


                </div>


                <%= f.submit id: "place_name",
                             class: "btn btn-primary width-6em",
                             tabindex: increment_tab_index,
                             title: "Select to #{namePlaced ? 'update' : 'place'} this name.",
                             value: "#{namePlaced ? 'Update' : 'Place'}" %>


                <div id="place_name_error_block">
                </div>

            <% end %>

            <%= divider %>
        <% end %>

        <% if instancePlaced %>
            <%= form_for(@current_workspace, controller: 'Trees', action: 'patch', remote: true, url: :tree_arrangement_remove_name) do |f| %>
                <%= f.hidden_field(:name_id, value: @instance.name.id) %>
                <%= f.hidden_field(:instance_id, value: @instance.id) %>
                <h3>Remove name from <%= @current_workspace.derivedLabel %></h3>

                <u><%= raw(@instance.name.full_name_html) %></u> will be removed from
                <%= @current_workspace.derivedLabel %> <br/> in workspace
                <u><%= @current_workspace.title %></u>.

                <%= f.submit id: "remove_name_placement",
                             class: "btn btn-primary width-6em",
                             tabindex: increment_tab_index,
                             title: "Select to remove this name.",
                             value: "Remove" %>

                <div id="remove_name_error_block"></div>

            <% end %>
            <%= divider %>
        <% end %>


        <% if instancePlaced %>
            <h5> <%= @current_classification.derivedLabel %> Placement Notes</h5>
            <%
              if @current_classification.tree_type == 'U'
                # a workspace is editable if the user is a member of the group
                # named by the workspace's base classification
                baseTree = TreeArrangement.find(@current_classification.base_arrangement_id)
              else
                # only workspaces are editable
                baseTree = @current_classification
              end
            %>
            <% TreeValueUri.where(root: baseTree).order(:sort_order).each do |u|
            %>
                <% if u.is_multi_valued? %>
                    <!-- don't know how to handle multivalued attribute <%= u.label %> -->
                <% else %>
                    <%= form_for(@current_classification, controller: 'Trees', action: 'patch', remote: true, url: :tree_arrangement_update_value) do |f| %>
                        <%= f.hidden_field(:name_id, value: @instance.name.id) %>
                        <%= f.hidden_field(:value_label, value: u.label) %>

                        <% current_value_link = placement.subnode.valueLink(u) %>

                        <label for="node-value-<%= u.label %>"><%= u.title %></label>
                        <textarea name="value" title="<%=u.title%>"><%= current_value_link.subnode.literal unless current_value_link.nil? %></textarea>

                        <%= f.submit id: "update_value",
                                     class: "btn btn-primary width-6em",
                                     tabindex: increment_tab_index,
                                     title: "Update",
                                     value: "Update" %>

                    <% end %>
                <% end %>
            <% end %>
            <%= divider %>
        <% end %>

    <% end %>



<% else %>
    <h5>No classification selected</h5>
    <p>
      Select a classification or workspace from the User&nbsp;&gt;&nbsp;Classifications menu.
    </p>
<% end %>


